name: Weekly Benchmark

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run benchmarks weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      ruby-versions: ${{ steps.set-matrix.outputs.ruby-versions }}
      platforms: ${{ steps.set-matrix.outputs.platforms }}
    steps:
      - name: Set matrix configurations
        id: set-matrix
        run: |
          echo 'ruby-versions=["3.1", "3.2", "3.3", "3.4"]' >> $GITHUB_OUTPUT
          echo 'platforms=["ubuntu-latest", "macos-latest"]' >> $GITHUB_OUTPUT

  # Cross-platform native benchmarks
  benchmark:
    runs-on: ${{ matrix.platform }}
    needs: setup
    strategy:
      matrix:
        platform: ${{ fromJson(needs.setup.outputs.platforms) }}
        ruby-version: ${{ fromJson(needs.setup.outputs.ruby-versions) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby-version }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          bundler-cache: true

      - name: Install system dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt1-dev build-essential

      - name: Install system dependencies (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          brew install libxml2 libxslt

      - name: Install gems
        run: bundle install

      - name: Update Ruby-Build cache
        run: bundle exec serialbench ruby-build update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create environment config
        run: |
          mkdir -p config/environments
          cat > config/environments/ci-ruby-${{ matrix.ruby-version }}.yml << EOF
          ---
          name: ci-ruby-${{ matrix.ruby-version }}-${{ matrix.platform }}
          kind: local
          created_at: '$(date -u +"%Y-%m-%dT%H:%M:%SZ")'
          ruby_build_tag: "${{ matrix.ruby-version }}"
          description: CI environment for Ruby ${{ matrix.ruby-version }} on ${{ matrix.platform }}
          EOF

      - name: Run benchmarks
        run: |
          bundle exec serialbench environment execute \
            config/environments/ci-ruby-${{ matrix.ruby-version }}.yml \
            config/benchmarks/short.yml \
            results/runs/ci-ruby-${{ matrix.ruby-version }}-${{ matrix.platform }}

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ matrix.platform }}-ruby-${{ matrix.ruby-version }}
          path: results/runs/ci-ruby-${{ matrix.ruby-version }}-${{ matrix.platform }}/
          retention-days: 30

  # Aggregate results and deploy to GitHub Pages
  deploy-pages:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs: [setup, benchmark]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt1-dev build-essential

      - name: Install gems
        run: bundle install

      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: benchmark-results-*
          path: artifacts/

      - name: Create resultset
        run: |
          mkdir -p results/sets
          bundle exec serialbench resultset create weekly-benchmark results/sets/weekly-benchmark

      - name: Add all results to resultset
        run: |
          for dir in artifacts/benchmark-results-*/ci-ruby-*; do
            if [ -d "$dir" ]; then
              echo "Adding result from: $dir"
              bundle exec serialbench resultset add-result results/sets/weekly-benchmark "$dir"
            fi
          done

      - name: Generate GitHub Pages site
        run: |
          bundle exec serialbench resultset build-site results/sets/weekly-benchmark _site

      - name: Create summary page
        run: |
          mkdir -p _site
          cat > _site/README.md << 'EOF'
          # Serialbench - Weekly Benchmark Results

          This site contains automated benchmark results for Ruby serialization libraries.

          ## Benchmarked Libraries

          - **XML**: REXML, Ox, Nokogiri, Oga, LibXML
          - **JSON**: JSON, Oj, RapidJSON, YAJL
          - **YAML**: Psych
          - **TOML**: TOML-RB, Tomlib, tomlrb

          ## Platforms Tested

          - Ubuntu Latest (Linux x86_64)
          - macOS Latest (Apple Silicon/Intel)

          ## Ruby Versions

          - Ruby 3.1, 3.2, 3.3, 3.4

          ## View Results

          Open [index.html](./index.html) to view the interactive dashboard.

          ---

          *Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs: [setup, benchmark, deploy-pages]
    if: always()
    steps:
      - name: Generate workflow summary
        run: |
          echo "## Weekly Benchmark Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Benchmark Status**: ${{ needs.benchmark.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Status**: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platforms Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu Latest (Linux x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS Latest (Apple Silicon/Intel)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ruby Versions" >> $GITHUB_STEP_SUMMARY
          echo "- Ruby 3.1, 3.2, 3.3, 3.4" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Serialization Libraries" >> $GITHUB_STEP_SUMMARY
          echo "- **XML**: REXML, Ox, Nokogiri, Oga, LibXML" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON**: JSON, Oj, RapidJSON, YAJL" >> $GITHUB_STEP_SUMMARY
          echo "- **YAML**: Psych" >> $GITHUB_STEP_SUMMARY
          echo "- **TOML**: TOML-RB, Tomlib, tomlrb" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š [View Interactive Dashboard](https://metanorma.github.io/serialbench/)" >> $GITHUB_STEP_SUMMARY
          fi
